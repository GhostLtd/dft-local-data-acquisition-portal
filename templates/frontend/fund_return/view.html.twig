{%- extends 'frontend/base.html.twig' -%}

{%- set page_title = breadcrumbBuilder.titleFor('fund_return') -%}
{%- set page_heading_class = 'govuk-heading-l' -%}

{%- block content -%}
    {%- from "@GhostGovUkFrontend/components/macros.html.twig" import summaryListStart, summaryListEnd, summaryListRow -%}
    {%- from "frontend/macros.html.twig" import displayCardsForReturn, displaySectionsInline, displaySectionsAsTabs, ratingTag, text, expenseDivisionComments -%}
    {%- from "frontend/fund_return/macros.html.twig" import overallProgressContent %}

    {# -- DETAILS ---------------------------------------------------------------------------------------------------- #}

    {# @var fundReturn \App\Entity\FundReturn\CrstsFundReturn #}

    {%- set baseOptions = {return: fundReturn, is_expense: false} -%}
    {%- set configs = [] -%}

    {%- set contents -%}
        {{- summaryListStart() -}}
        {{- text('frontend.pages.fund_return.lead_contact', fundReturn.fundAward.leadContact.name) -}}
        {{- summaryListRow({key: 'frontend.pages.fund_return.sign_off' | trans, value: _self.signoff(fundReturn.signoffDate, fundReturn.signoffName, fundReturn.signoffUser ?? fundReturn.signoffEmail)}) -}}
        {{- summaryListEnd() -}}
    {%- endset -%}

    {%- set configs = configs|merge([{
        title: 'frontend.pages.fund_return.titles.basic_details' | trans,
        section: 'basic_details',
        contents,
        options: {add_edit_link: false},
    }]) -%}

    {%- set configs = configs|merge([{
        title: 'frontend.pages.fund_return.titles.overall_progress' | trans,
        section: 'overall_progress',
        contents: overallProgressContent(fundReturn),
    }]) -%}

    {%- set contents -%}
        {{- summaryListStart() -}}
        {{- text('frontend.pages.fund_return.local_contribution', fundReturn.localContribution) -}}
        {{- text('frontend.pages.fund_return.resource_funding', fundReturn.resourceFunding) -}}
        {{- summaryListEnd() -}}
    {%- endset -%}

    {%- set configs = configs|merge([{
        title: 'frontend.pages.fund_return.titles.local_and_rdel' | trans,
        section: 'local_and_rdel',
        contents,
    }]) -%}

    {%- set contents -%}
        {{- summaryListStart() -}}
        {{- text('frontend.pages.fund_return.comments', fundReturn.comments) -}}
        {{- summaryListEnd() -}}
    {%- endset -%}

    {%- set configs = configs|merge([{
        title: 'frontend.pages.fund_return.titles.comments' | trans,
        section: 'comments',
        contents,
    }]) -%}

    {{- displayCardsForReturn(
        'frontend.pages.fund_return.titles.fund_details' | trans,
        configs,
        fundReturn
    ) -}}

    {# -- EXPENSES --------------------------------------------------------------------------------------------------- #}

    {%- set sections = [] -%}

    {%- from "frontend/macros.html.twig" import renderTable -%}
    {%- for division in expenseDivisions -%}
        {%- set divisionConfiguration = fundReturn.findDivisionConfigurationByKey(division.key) -%}
        {%- do expensesTableHelper.setDivisionConfiguration(divisionConfiguration) -%}
        {%- set contents -%}
            {%- if is_granted('CAN_EDIT', fundReturn) -%}
                {%- set url = section_edit_path(fundReturn, division.key, true) -%}
                <div class="expenses-links">
                    <a class="govuk-link" href="{{ url }}">{{ 'common.actions.edit' | trans }} <span class="govuk-visually-hidden">{{ division.label | trans }}</span></a>
                </div>
            {%- endif -%}
            {%- set table = expensesTableCalculator.calculate(expensesTableHelper.getTable(), fundReturn) -%}
            {{- renderTable(table) -}}
            {{- expenseDivisionComments(fundReturn, division) -}}
        {%- endset -%}
        {%- set sections = sections|merge([{
            label: division.label | trans,
            id: 'expenses-' ~ division.key,
            panel: {html: contents},
        }]) -%}
    {%- endfor -%}

    {{- displaySectionsAsTabs(sections, 'frontend.pages.fund_return.titles.expenses' | trans) -}}

    {# -- SCHEMES ---------------------------------------------------------------------------------------------------- #}

    <h2 class="govuk-heading-m">{{ 'frontend.pages.fund_return.titles.schemes' | trans }}</h2>

    {%- from '@GhostGovUkFrontend/components/macros.html.twig' import tableRow, tag, summaryListActionsList -%}
    {%- from "@GhostGovUkCore/list-page.html.twig" import listTableStart, listTableEnd -%}

    {%- set listData = schemeListPage.data -%}
    {%- set listForm = schemeListPage.filtersForm.createView -%}

    {%- form_theme listForm '@GhostGovUkFrontend/theme.html.twig' -%}

    <div class="scheme-list" id="scheme-list">
    {{- listTableStart(listData, listForm) -}}
    {%- for result in listData.entities -%}
        {%- set actions = is_granted('CAN_VIEW', result.schemeReturn) ? [
            {
                href: path('app_scheme_return', {fundReturnId: fundReturn.id, schemeFundId: result.schemeFund.id}),
                text: 'common.actions.view' | trans,
            },
        ] : [] -%}
        {%- set nameHtml %}<div class="govuk-!-font-weight-bold">{{ result.schemeFund.scheme.name }}</div>{% endset -%}
        {%- set readyForSignoffHtml -%}
            {%- if result.schemeReturn is not null -%}
                {{ (result.schemeReturn.readyForSignoff ? 'common.text.yes' : 'common.text.no') | trans }}
            {%- else -%}
                {{ '-' }}
            {%- endif -%}
        {%- endset -%}
        {%- set onTrackHtml -%}
            {%- if result.schemeReturn is not null -%}
                {%- set ratingEnum = result.schemeReturn.onTrackRating -%}
                {{- ratingEnum is null ? '-' : tag({text: "enum.on_track_rating.#{ratingEnum.value}" | trans, classes: ratingEnum.tagClass}) -}}
            {%- else -%}
                {{ '-' }}
            {%- endif -%}
        {%- endset -%}
        {{- tableRow([
            {html: nameHtml},
            {html: readyForSignoffHtml},
            {text: (result.schemeFund.retained ? 'common.scheme.retained' : 'common.scheme.non_retained') | trans},
            {html: onTrackHtml},
            {html: summaryListActionsList(actions)},
        ]) -}}
    {%- else -%}
        {{- tableRow([
            {
                text: 'common.text.no_results' | trans,
                colspan: listData.fields | length + 1,
            }
        ]) -}}
    {%- endfor -%}
    {{- listTableEnd(listData, listForm) -}}
    </div>
    {%- if is_granted('CAN_SIGN_OFF_RETURN', fundReturn) -%}
        <p class="govuk-body">
            <a class="govuk-button govuk-button--red" href="{{ path('app_fund_return_signoff', {fundReturnId: fundReturn.id}) }}">Signoff and submit return</a>
        </p>
    {%- endif -%}
{%- endblock -%}

{% macro signoff(date, name, link) -%}
    {%- if (date ?? false) -%}
        <a href="{{ link.id ?? false ? "/user/#{link.id}" : "mailto:#{link}" }}">{{ name }}</a> ({{ date | date('format.date-time.default' | trans) -}})
    {%- else -%}
        -
    {%- endif -%}
{%- endmacro %}